# Codecov Configuration for PineCMS
# Documentation: https://docs.codecov.com/docs/codecov-yaml
# Last Updated: 2025-11-09

codecov:
  require_ci_to_pass: yes
  notify:
    wait_for_ci: yes
    after_n_builds: 2  # Wait for both PHP and JS coverage

coverage:
  precision: 2
  round: down
  range: "70...100"  # Red at 70%, green at 100%

  status:
    project:
      default:
        target: 80%
        threshold: 2%  # Stricter threshold
        base: auto
        if_ci_failed: error
        informational: false
        only_pulls: false

    patch:
      default:
        target: 85%  # New code requires higher coverage
        threshold: 1%  # Very strict for new code
        base: auto
        if_ci_failed: error
        informational: false
        only_pulls: false

parsers:
  gcov:
    branch_detection:
      conditional: yes
      loop: yes
      macro: no
      method: no

comment:
  layout: "reach,diff,flags,tree,footer"
  behavior: default
  require_changes: false
  require_base: no
  require_head: yes

ignore:
  # Tests & Test Helpers
  - "tests/**/*"
  - "**/*.spec.js"
  - "**/*.test.js"
  - "**/*.spec.ts"
  - "**/*.test.ts"

  # Laravel Bootstrap & Framework
  - "bootstrap/**/*"
  - "config/**/*"  # Config files are hard to test
  - "storage/**/*"
  - "public/**/*"

  # Views (Blade templates - hard to test)
  - "resources/views/**/*"

  # Database
  - "database/factories/**/*"
  - "database/seeders/**/*"

  # Vendor
  - "vendor/**/*"
  - "node_modules/**/*"

  # Exception handlers (hard to test meaningfully)
  - "app/Exceptions/**/*"

  # Build Output
  - "coverage/**/*"
  - "dist/**/*"

  # Language Files
  - "lang/**/*"
  - "resources/lang/**/*"

flags:
  # PHP Backend Coverage
  php:
    paths:
      - app/
      - routes/
    carryforward: true
    # Require 80% coverage for PHP code
    target: 80%

  # JavaScript Frontend Coverage
  javascript:
    paths:
      - resources/js/
    carryforward: true
    # Require 75% coverage for JS code (frontend is harder to test)
    target: 75%

# Flag Management (auto-carryforward for incomplete builds)
flag_management:
  default_rules:
    carryforward: true
    statuses:
      - type: project
        target: 80%
      - type: patch
        target: 85%

# GitHub Checks Configuration
github_checks:
  annotations: true

# Codecov AI Features (NEW 2024/2025)
ai:
  enabled: true
  # Let Codecov AI suggest coverage improvements
